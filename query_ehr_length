import os
import pandas as pd
from google.cloud import bigquery
my_bucket = os.getenv('WORKSPACE_BUCKET')
cdr = os.getenv('WORKSPACE_CDR')


# 1. SETUP VARIABLES
# ---------------------------------------------------------
my_bucket = os.getenv('WORKSPACE_BUCKET')
cdr = os.getenv('WORKSPACE_CDR')
csv_filename = "ids.csv" # <--- NAME OF THE FILE WITH PARTICIPANT IDS

# 2. CONFIGURE EXTERNAL TABLE (CSV file with participant IDs to be read in as external table)
# ---------------------------------------------------------
client = bigquery.Client()
cohort_table_id = "my_cohort_table"

external_config = bigquery.ExternalConfig("CSV")
external_config.source_uris = [f'{my_bucket}/data/{csv_filename}']
external_config.schema = [
    bigquery.SchemaField('person_id', 'INT64') 
]
external_config.options.skip_leading_rows = 1 
job_config = bigquery.QueryJobConfig(table_definitions={cohort_table_id: external_config})

# 3. SQL QUERY (Using {cdr} and person_id)
# ---------------------------------------------------------
query = f"""
WITH ehr AS (
    SELECT m.person_id, MIN( m.measurement_date) AS first_date, MAX( m.measurement_date) AS last_date
    FROM `{cdr}.measurement` m
    LEFT JOIN `{cdr}.measurement_ext` AS m_ext ON m.measurement_id = m_ext.measurement_id
    WHERE LOWER(m_ext.src_id) LIKE 'ehr site%'
    GROUP BY 1
    UNION DISTINCT
    SELECT co.person_id, MIN(co.condition_start_date) AS first_date,
    CASE WHEN MAX(co.condition_start_date)>= MAX(co.condition_end_date) OR MAX( co.condition_end_date) IS NULL THEN MAX(co.condition_start_date)
    WHEN MAX(co.condition_start_date) < MAX(co.condition_end_date) OR MAX(co.condition_start_date) IS NULL THEN MAX(co.condition_end_date)
    END AS last_date
    FROM `{cdr}.condition_occurrence` AS co
    LEFT JOIN `{cdr}.condition_occurrence_ext` AS co_ext ON co.condition_occurrence_id = co_ext.condition_occurrence_id
    WHERE LOWER(co_ext.src_id) LIKE 'ehr site%'
    GROUP BY 1
    UNION DISTINCT
    SELECT d.person_id, MIN( d.device_exposure_start_date) AS first_date,
    CASE WHEN MAX(d.device_exposure_start_date)>= MAX(d.device_exposure_end_date) OR MAX(d.device_exposure_end_date) IS NULL THEN MAX(d.device_exposure_start_date)
    WHEN MAX(d.device_exposure_start_date) < MAX(d.device_exposure_end_date) OR  MAX(d.device_exposure_start_date) IS NULL THEN MAX(d.device_exposure_end_date)
    END AS last_date
    FROM `{cdr}.device_exposure` AS d
    LEFT JOIN `{cdr}.device_exposure_ext` AS d_ext ON d.device_exposure_id = d_ext.device_exposure_id
    WHERE LOWER(d_ext.src_id) LIKE 'ehr site%'
    GROUP BY 1
    UNION DISTINCT
    SELECT de.person_id, MIN(de.drug_exposure_start_date) AS first_date,
      CASE WHEN MAX(de.drug_exposure_start_date) >= MAX(de.drug_exposure_end_date) OR MAX(de.drug_exposure_end_date) IS NULL THEN MAX(de.drug_exposure_start_date)
     WHEN MAX(de.drug_exposure_start_date)< MAX(de.drug_exposure_end_date) OR MAX(de.drug_exposure_start_date) IS NULL THEN MAX(de.drug_exposure_end_date)
     END AS last_date
    FROM `{cdr}.drug_exposure` AS de
    LEFT JOIN `{cdr}.drug_exposure_ext` AS de_ext ON de.drug_exposure_id = de_ext.drug_exposure_id
    WHERE LOWER(de_ext.src_id) LIKE 'ehr site%'
    GROUP BY 1
    UNION DISTINCT
    SELECT o.person_id, MIN(o.observation_date) AS first_date,
    MAX(o.observation_date) AS last_date
    FROM `{cdr}.observation` AS o
    LEFT JOIN `{cdr}.observation_ext` AS o_ext ON o.observation_id = o_ext.observation_id
    WHERE LOWER(o_ext.src_id) LIKE 'ehr site%'
    GROUP BY 1
    UNION DISTINCT
    SELECT po.person_id, MIN(po.procedure_date) AS first_date,
     MAX(po.procedure_date) AS last_date
     FROM `{cdr}.procedure_occurrence` AS po
    LEFT JOIN `{cdr}.procedure_occurrence_ext` AS po_ext ON po.procedure_occurrence_id = po_ext.procedure_occurrence_id
    WHERE LOWER(po_ext.src_id) LIKE 'ehr site%'
    GROUP BY 1
    UNION DISTINCT
    SELECT v.person_id, MIN( v.visit_start_date ) AS first_date,
     CASE WHEN MAX ( v.visit_start_date )>= MAX( v.visit_end_date ) OR MAX( v.visit_end_date ) IS NULL THEN  MAX(v.visit_start_date)
    WHEN MAX ( v.visit_start_date ) < MAX ( v.visit_end_date ) OR MAX( v.visit_start_date ) IS NULL THEN MAX ( v.visit_end_date )
    END AS  last_date
     FROM `{cdr}.visit_occurrence` AS v
    LEFT JOIN `{cdr}.visit_occurrence_ext` AS v_ext ON v.visit_occurrence_id = v_ext.visit_occurrence_id
    WHERE LOWER(v_ext.src_id) LIKE 'ehr site%'
    GROUP BY 1
)
SELECT
    e.person_id,
    COUNT(e.person_id) AS record_count,
    MIN(e.first_date) AS first_ehr_date,
    MAX(e.last_date) as last_ehr_date,
    DATE_DIFF(DATE(MAX(e.last_date)), DATE(MIN(e.first_date)), day) + 1 AS ehr_data_length
FROM ehr e
INNER JOIN {cohort_table_id} c ON e.person_id = c.person_id
GROUP BY 1
ORDER BY 1 DESC
"""

# 4. EXECUTE
# ---------------------------------------------------------
df = client.query(query, job_config=job_config).to_dataframe()

print(df.head())
